<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Rates</title>
    <link rel="stylesheet" type="text/css" href="css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

    <header id="navbar"></header>
   <div class= "parentPage4">
    <h2 class="topTitle"> Flu Hospitalization Rates </h2>

    <div class="controls-container">
        <div class="rate-option">
            <label for="options">Rate</label>
            <div class="radio-container">
                <input type="radio" id="cumulative_rate" name="options" value="cumulative_rate" checked>
                <label for="cumulative_rate">Cumulative</label>
                <input type="radio" id="weekly_rate" name="options" value="weekly_rate">
                <label for="weekly_rate">Weekly</label>
            </div>
        </div>
        <div class="year-option">
            <label class="form-label" for="yearDropdown">Flu Season</label>
            <div class="dropdown">
                <button class="btn btn-primary dropdown-toggle" type="button" id="yearDropdownButton"
                    data-bs-toggle="dropdown" aria-expanded="false">
                    2018 - 2019
                </button>
                <ul class="dropdown-menu" aria-labelledby="yearDropdownButton" id="yearDropdown"></ul>
            </div>
        </div>

        <div class="category-option">
            <label class="form-label" for="categoryDropdown">Category</label>
            <div class="dropdown">
                <button class="btn btn-primary dropdown-toggle" type="button" id="categoryDropdownButton"
                    data-bs-toggle="dropdown" aria-expanded="false">
                    Age
                </button>
                <ul class="dropdown-menu" aria-labelledby="categoryDropdownButton" id="categoryDropdown">
                    <li><a class="dropdown-item" href="#" data-value="age">Age</a></li>
                    <li><a class="dropdown-item" href="#" data-value="sex">Sex</a></li>
                    <li><a class="dropdown-item" href="#" data-value="race">Race</a></li>
                    <li><a class="dropdown-item" href="#" data-value="site">Site</a></li>
                </ul>
            </div>
        </div>

        <div class="option-option">
            <label class="form-label" for="optionDropdown">Option</label>
            <div class="dropdown">
                <button class="btn btn-primary dropdown-toggle" type="button" id="optionDropdownButton"
                    data-bs-toggle="dropdown" aria-expanded="false">
                    Select Option
                </button>
                <ul class="dropdown-menu" aria-labelledby="optionDropdownButton" id="optionDropdown"></ul>
            </div>
        </div>


    </div>
    <div id="liveAlertPlaceholder"></div>

    <div class="aids">
        <div class="chart-container">
            <canvas id="lineChart"></canvas>
        </div>
    </div>
   </div>
    <script>
        fetch('navbar.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('navbar').innerHTML = data;
                const currentPage = window.location.pathname;
                let activeLink = null;
                if (currentPage.includes('LocationPage.html')) {
                    activeLink = document.getElementById('page1-link');
                } else if (currentPage.includes('page2.cfm')) {
                    activeLink = document.getElementById('page2-link');
                } else if (currentPage.includes('page3.html')) {
                    activeLink = document.getElementById('page3-link');
                } else if (currentPage.includes('page4.html')) {
                    activeLink = document.getElementById('page4-link');
                }

                if (activeLink) {
                    activeLink.classList.add('active');
                }

       		const navbarCollapse = document.querySelector('.navbar-collapse');
        
		navbarCollapse.addEventListener('show.bs.collapse', () => {
  			document.body.style.overflow = 'hidden';
		});

		navbarCollapse.addEventListener('hidden.bs.collapse', () => {
  			document.body.style.overflow = 'visible';
		});

            })
            .catch(error => {
                console.error('Error loading navigation bar:', error);
            });

    </script>

    <script>
        document.getElementById('yearDropdown').addEventListener('click', function (event) {
            if (event.target.classList.contains('dropdown-item')) {
                var selectedYear = event.target.getAttribute('data-value');
                document.getElementById('yearDropdownButton').textContent = selectedYear - 1 + " - " + selectedYear;
            }
        });
        document.getElementById('categoryDropdown').addEventListener('click', function (event) {
            if (event.target.classList.contains('dropdown-item')) {
                var selectedCategory = event.target.getAttribute('data-value');
                document.getElementById('categoryDropdownButton').textContent = selectedCategory[0].toUpperCase() + selectedCategory.slice(1);
                updateIt(selectedCategory);
            }
        });
        document.getElementById('optionDropdown').addEventListener('click', function (event) {
            if (event.target.classList.contains('dropdown-item')) {
                var selectedOption = event.target.textContent;
                document.getElementById('optionDropdownButton').textContent = selectedOption;
            }
        });
        //Listeners to populate Drop Downs Dynamically
        document.addEventListener('DOMContentLoaded', fetchAges);
        document.addEventListener('DOMContentLoaded', fetchYears);

        //Function to update the selected Drop Down with options
        function updateIt(selectedThing) {
            if (selectedThing == 'age') {
                fetchAges();
            }
            else if (selectedThing == 'sex') {
                fetchSexes()
            }
            else if (selectedThing == 'race') {
                fetchRaces();
            }
            else if (selectedThing == 'site') {
                fetchSites()
            }
            else {
                console.log("error")
            }

        }

        //These functions dynamically fetch from the database for the options in the category
        function fetchSexes() {
            fetch('/Projects/backend/api/Page4Apis/GetSexes.cfm')
                .then(response => response.json())
                .then(data => {
                    populateOptionDropdown(data.DATA);
                })
                .catch(error => {
                    console.error('Error fetching sexes:', error);
                });
        }
        function fetchSites() {
            fetch('/Projects/backend/api/Page4Apis/GetSites.cfm')
                .then(response => response.json())
                .then(data => {
                    populateOptionDropdown(data.DATA);
                })
                .catch(error => {
                    console.error('Error fetching sites:', error);
                });
        }
        function fetchAges() {
            fetch('/Projects/backend/api/Page4Apis/GetAges.cfm')
                .then(response => response.json())
                .then(data => {
                    populateOptionDropdown(data.DATA);
                })
                .catch(error => {
                    console.error('Error fetching ages:', error);
                });
        }
        function fetchRaces() {
            fetch('/Projects/backend/api/Page4Apis/GetRaces.cfm')
                .then(response => response.json())
                .then(data => {
                    populateOptionDropdown(data.DATA);
                })
                .catch(error => {
                    console.error('Error fetching races:', error);
                });
        }
        function fetchYears() {
            fetch('/Projects/backend/api/Page4Apis/GetYears.cfm')
                .then(response => response.json())
                .then(data => {
                    data.DATA.shift()
                    populateDropdown(data.DATA);
                })
                .catch(error => {
                    console.error('Error fetching years:', error);
                });
        }

        //Populate the drop down and when the category changes, activate handleInputChange()
        function populateOptionDropdown(choices) {
            var dropdown = document.getElementById('optionDropdown');
            dropdown.innerHTML = '';


            choices.forEach(function (choice) {
                var listItem = document.createElement('li');
                listItem.innerHTML = '<a class="dropdown-item" href="#">' + choice + '</a>';
                dropdown.appendChild(listItem);
            });
            document.getElementById('optionDropdownButton').textContent = choices[0];
            handleInputChange()

        }
        function populateDropdown(years) {
            var dropdown = document.getElementById('yearDropdown');
            dropdown.innerHTML = '';

            years.forEach(function (year) {
                var option = document.createElement('li');
                option.innerHTML = '<a class="dropdown-item" href="#" data-value="' + year + '">' + (year - 1) + ' - ' + year + '</a>';
                dropdown.appendChild(option);
            });
        }
        var lineChart;
        document.addEventListener('DOMContentLoaded', fetchData(2019, 'overall', 'overall', '0-<1 year', 'overall', 'cumulative_rate'));


        //Add listeners for the second drop down of options
        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('yearDropdown').addEventListener('click', handleInputChange);
            document.getElementById('optionDropdown').addEventListener('click', handleInputChange);
            var radioButtons = document.querySelectorAll('input[type="radio"][name="options"]');
            radioButtons.forEach(function (radioButton) {
                radioButton.addEventListener('change', handleInputChange);
            });
        });

        function handleInputChange() {

            var selectedThing = document.getElementById('categoryDropdownButton').textContent.trim();
            console.log(selectedThing)
            var selectedAge = 'overall'
            var selectedSex = 'overall'
            var selectedRace = 'overall'
            var selectedSite = 'overall'
            if (selectedThing == 'Age') {
                selectedAge = document.getElementById('optionDropdownButton').textContent;
            }
            else if (selectedThing == 'Sex') {
                selectedSex = document.getElementById('optionDropdownButton').textContent;
            }
            else if (selectedThing == 'Race') {
                selectedRace = document.getElementById('optionDropdownButton').textContent;
            }
            else if (selectedThing == 'Site') {
                selectedSite = document.getElementById('optionDropdownButton').textContent;
            }
            else {
                console.log("error")
            }
            var selectedYear = document.getElementById('yearDropdownButton').textContent;
            actualYear = selectedYear.split(' - ')[1];


            var selectedOption = document.querySelector('input[type="radio"][name="options"]:checked').value;
            console.log(actualYear, selectedRace, selectedSex, selectedAge, selectedSite, selectedOption, "this")
            fetchData(actualYear, selectedRace, selectedSex, selectedAge, selectedSite, selectedOption);
        }


        function fetchData(year, race, sex, age, site, rate) {
            var age2 = encodeURIComponent(age);
            var url = `/Projects/backend/api/Page4Apis/hospitalizations.cfm?year=${year}&age=${age2}&race=${race}&sex=${sex}&site=${site}&rate=${rate}`;
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (lineChart) {
                        lineChart.destroy();
                    }
                    updateChart(data, year, race, sex, age, site, rate);
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                });
        }

        function updateChart(data, year, race, sex, age, site, rate) {
            var columns = data.COLUMNS;
            var rowData = data.DATA;
            console.log(year, race, sex, age, site, rate)
            var labels = rowData.map(row => row[0].slice(0, 10));
            var weeklyRates = rowData.map(row => row[1]);
            console.log(data.COLUMNS[1])
            var yAxisText = ''
            if (data.COLUMNS[1] == 'CUMULATIVE_RATE') {
                yAxisText = 'Cumulative Rates per 100,000';
            }
            else if (data.COLUMNS[1] == 'WEEKLY_RATE') {
                yAxisText = 'Weekly Rates per 100,000';
            }
            else {
                yAxisText = 'Rates per 100,000';
            }
            const alertPlaceholder = document.getElementById('liveAlertPlaceholder')
            const chartContainer = document.querySelector('.chart-container');
            const appendAlert = (message, type) => {
                alertPlaceholder.innerHTML = '';

                const wrapper = document.createElement('div')
                wrapper.innerHTML = [
                    `<div class="alert alert-primary alert-dismissible text-center"  role="alert">`,
                    `   <div>${message}</div>`,
                    '   <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>',
                    '</div>'
                ].join('')
                alertPlaceholder.append(wrapper)
                chartContainer.classList.add('small');
            }
            var selectedCategory = document.getElementById('categoryDropdownButton').textContent.trim();
            var selectedYear = document.getElementById('yearDropdownButton').textContent;
            var selectedOption = document.getElementById('optionDropdownButton').textContent;


            if (weeklyRates.length == 0) {
                appendAlert('No available data for: Flu Season ' + selectedYear + ', Category: ' + selectedCategory + ', Option: ' + selectedOption, 'success')
            }
            const removeAlert = () => {
                chartContainer.classList.remove('small');
            };

            alertPlaceholder.addEventListener('click', (event) => {
                if (event.target.classList.contains('btn-close')) {
                    removeAlert();
                }
            });
            if (weeklyRates.length != 0) {
                alertPlaceholder.innerHTML = '';
                removeAlert();
            }


            var ctx = document.getElementById('lineChart').getContext('2d');
            lineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: yAxisText,
                        data: weeklyRates,
                        borderColor: 'blue',
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                    },

                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                font: {
                                    size: function (context) {

                                        return Math.round(0.02 * window.innerHeight);
                                    },
                                    family: 'Arial',

                                },
                                color: 'black',
                                padding: {
                                    top: 20
                                },
                                text: 'Dates'
                            },
                            scaleLabel: {
                                display: true,
                                labelString: 'Dates'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                font: {
                                    size: function (context) {

                                        return Math.round(0.02 * window.innerHeight);
                                    },
                                    family: 'Arial'
                                },
                                color: 'black',
                                padding: {
                                    bottom: 20
                                },
                                text: yAxisText
                            },
                            scaleLabel: {
                                display: true,
                                labelString: 'Weekly Rates'
                            }
                        }
                    }
                }
            });
        }

    </script>

</body>

</html>